<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Designer.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">PMD Core</a> &gt; <a href="index.source.html" class="el_package">net.sourceforge.pmd.util.designer</a> &gt; <span class="el_source">Designer.java</span></div><h1>Designer.java</h1><pre class="source lang-java linenums">/**
 * BSD-style license; for more info see http://pmd.sourceforge.net/license.html
 */

package net.sourceforge.pmd.util.designer;

import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Component;
import java.awt.Dimension;
import java.awt.Font;
import java.awt.Toolkit;
import java.awt.datatransfer.Clipboard;
import java.awt.datatransfer.ClipboardOwner;
import java.awt.datatransfer.StringSelection;
import java.awt.datatransfer.Transferable;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.ComponentEvent;
import java.awt.event.KeyEvent;
import java.awt.event.MouseEvent;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileWriter;
import java.io.IOException;
import java.io.InputStream;
import java.io.StringReader;
import java.io.StringWriter;
import java.lang.reflect.Proxy;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.Enumeration;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;

import javax.swing.AbstractAction;
import javax.swing.AbstractButton;
import javax.swing.ActionMap;
import javax.swing.BorderFactory;
import javax.swing.ButtonGroup;
import javax.swing.DefaultListModel;
import javax.swing.InputMap;
import javax.swing.JButton;
import javax.swing.JComponent;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JList;
import javax.swing.JMenu;
import javax.swing.JMenuBar;
import javax.swing.JMenuItem;
import javax.swing.JPanel;
import javax.swing.JRadioButton;
import javax.swing.JRadioButtonMenuItem;
import javax.swing.JScrollPane;
import javax.swing.JSplitPane;
import javax.swing.JTabbedPane;
import javax.swing.JTextArea;
import javax.swing.JTree;
import javax.swing.KeyStroke;
import javax.swing.ListCellRenderer;
import javax.swing.ListSelectionModel;
import javax.swing.ScrollPaneConstants;
import javax.swing.WindowConstants;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import javax.swing.event.TreeSelectionEvent;
import javax.swing.event.TreeSelectionListener;
import javax.swing.event.UndoableEditEvent;
import javax.swing.event.UndoableEditListener;
import javax.swing.text.JTextComponent;
import javax.swing.tree.DefaultMutableTreeNode;
import javax.swing.tree.DefaultTreeCellRenderer;
import javax.swing.tree.DefaultTreeModel;
import javax.swing.tree.TreeCellRenderer;
import javax.swing.tree.TreeNode;
import javax.swing.tree.TreePath;
import javax.swing.tree.TreeSelectionModel;
import javax.swing.undo.CannotRedoException;
import javax.swing.undo.CannotUndoException;
import javax.swing.undo.UndoManager;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.transform.OutputKeys;
import javax.xml.transform.Result;
import javax.xml.transform.Source;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerException;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;

import org.apache.commons.io.IOUtils;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Text;
import org.xml.sax.SAXException;

import net.sourceforge.pmd.PMD;
import net.sourceforge.pmd.PMDConfiguration;
import net.sourceforge.pmd.RuleContext;
import net.sourceforge.pmd.RuleSet;
import net.sourceforge.pmd.RuleSetFactory;
import net.sourceforge.pmd.RuleSets;
import net.sourceforge.pmd.SourceCodeProcessor;
import net.sourceforge.pmd.lang.LanguageRegistry;
import net.sourceforge.pmd.lang.LanguageVersion;
import net.sourceforge.pmd.lang.LanguageVersionHandler;
import net.sourceforge.pmd.lang.Parser;
import net.sourceforge.pmd.lang.ast.Node;
import net.sourceforge.pmd.lang.ast.ParseException;
import net.sourceforge.pmd.lang.ast.xpath.Attribute;
import net.sourceforge.pmd.lang.ast.xpath.AttributeAxisIterator;
import net.sourceforge.pmd.lang.dfa.DFAGraphMethod;
import net.sourceforge.pmd.lang.dfa.DFAGraphRule;
import net.sourceforge.pmd.lang.rule.XPathRule;
import net.sourceforge.pmd.lang.symboltable.NameDeclaration;
import net.sourceforge.pmd.lang.symboltable.NameOccurrence;
import net.sourceforge.pmd.lang.symboltable.Scope;
import net.sourceforge.pmd.lang.symboltable.ScopedNode;
import net.sourceforge.pmd.lang.xpath.Initializer;
import net.sourceforge.pmd.util.StringUtil;

public class Designer implements ClipboardOwner {

<span class="nc" id="L128">    private boolean exitOnClose = true;</span>
<span class="nc" id="L129">    private final CodeEditorTextPane codeEditorPane = new CodeEditorTextPane();</span>
<span class="nc" id="L130">    private final TreeWidget astTreeWidget = new TreeWidget(new Object[0]);</span>
<span class="nc" id="L131">    private DefaultListModel xpathResults = new DefaultListModel();</span>
<span class="nc" id="L132">    private final JList xpathResultList = new JList(xpathResults);</span>
<span class="nc" id="L133">    private final JTextArea xpathQueryArea = new JTextArea(15, 30);</span>
<span class="nc" id="L134">    private final ButtonGroup xpathVersionButtonGroup = new ButtonGroup();</span>
<span class="nc" id="L135">    private final TreeWidget symbolTableTreeWidget = new TreeWidget(new Object[0]);</span>
<span class="nc" id="L136">    private final JFrame frame = new JFrame(&quot;PMD Rule Designer (v &quot; + PMD.VERSION + ')');</span>
<span class="nc" id="L137">    private final DFAPanel dfaPanel = new DFAPanel();</span>
<span class="nc" id="L138">    private final JRadioButtonMenuItem[] languageVersionMenuItems = new JRadioButtonMenuItem[getSupportedLanguageVersions().length];</span>
<span class="fc" id="L139">    private static final String SETTINGS_FILE_NAME = System.getProperty(&quot;user.home&quot;)</span>
            + System.getProperty(&quot;file.separator&quot;) + &quot;.pmd_designer.xml&quot;;

<span class="nc" id="L142">    public Designer(String[] args) {</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">        if (args.length &gt; 0) {</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">            exitOnClose = !args[0].equals(&quot;-noexitonclose&quot;);</span>
        }

<span class="nc" id="L147">        Initializer.initialize();</span>

<span class="nc" id="L149">        xpathQueryArea.setFont(new Font(&quot;Verdana&quot;, Font.PLAIN, 16));</span>
<span class="nc" id="L150">        JSplitPane controlSplitPane = new JSplitPane(JSplitPane.HORIZONTAL_SPLIT, createCodeEditorPanel(),</span>
                createXPathQueryPanel());

<span class="nc" id="L153">        JSplitPane astAndSymbolTablePane = new JSplitPane(JSplitPane.VERTICAL_SPLIT, createASTPanel(),</span>
                createSymbolTableResultPanel());

<span class="nc" id="L156">        JSplitPane resultsSplitPane = new JSplitPane(JSplitPane.HORIZONTAL_SPLIT, astAndSymbolTablePane,</span>
                createXPathResultPanel());

<span class="nc" id="L159">        JTabbedPane tabbed = new JTabbedPane();</span>
<span class="nc" id="L160">        tabbed.addTab(&quot;Abstract Syntax Tree / XPath / Symbol Table&quot;, resultsSplitPane);</span>
<span class="nc" id="L161">        tabbed.addTab(&quot;Data Flow Analysis&quot;, dfaPanel);</span>
<span class="nc" id="L162">        tabbed.setMnemonicAt(0, KeyEvent.VK_A);</span>
<span class="nc" id="L163">        tabbed.setMnemonicAt(1, KeyEvent.VK_D);</span>

<span class="nc" id="L165">        JSplitPane containerSplitPane = new JSplitPane(JSplitPane.VERTICAL_SPLIT, controlSplitPane, tabbed);</span>
<span class="nc" id="L166">        containerSplitPane.setContinuousLayout(true);</span>

<span class="nc" id="L168">        JMenuBar menuBar = createMenuBar();</span>
<span class="nc" id="L169">        frame.setJMenuBar(menuBar);</span>
<span class="nc" id="L170">        frame.getContentPane().add(containerSplitPane);</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">        frame.setDefaultCloseOperation(exitOnClose ? JFrame.EXIT_ON_CLOSE : WindowConstants.DISPOSE_ON_CLOSE);</span>

<span class="nc" id="L173">        Dimension screenSize = Toolkit.getDefaultToolkit().getScreenSize();</span>
<span class="nc" id="L174">        int screenHeight = screenSize.height;</span>
<span class="nc" id="L175">        int screenWidth = screenSize.width;</span>

<span class="nc" id="L177">        frame.pack();</span>
<span class="nc" id="L178">        frame.setSize(screenWidth * 3 / 4, screenHeight * 3 / 4);</span>
<span class="nc" id="L179">        frame.setLocation((screenWidth - frame.getWidth()) / 2, (screenHeight - frame.getHeight()) / 2);</span>
<span class="nc" id="L180">        frame.setVisible(true);</span>
<span class="nc" id="L181">        int horozontalMiddleLocation = controlSplitPane.getMaximumDividerLocation() * 3 / 5;</span>
<span class="nc" id="L182">        controlSplitPane.setDividerLocation(horozontalMiddleLocation);</span>
<span class="nc" id="L183">        containerSplitPane.setDividerLocation(containerSplitPane.getMaximumDividerLocation() / 2);</span>
<span class="nc" id="L184">        astAndSymbolTablePane.setDividerLocation(astAndSymbolTablePane.getMaximumDividerLocation() / 3);</span>
<span class="nc" id="L185">        resultsSplitPane.setDividerLocation(horozontalMiddleLocation);</span>

<span class="nc" id="L187">        loadSettings();</span>
<span class="nc" id="L188">    }</span>

    private int getDefaultLanguageVersionSelectionIndex() {
<span class="nc" id="L191">        return Arrays.asList(getSupportedLanguageVersions())</span>
                .indexOf(LanguageRegistry.getLanguage(&quot;Java&quot;).getDefaultVersion());
    }

    private Node getCompilationUnit() {
<span class="nc" id="L196">        LanguageVersionHandler languageVersionHandler = getLanguageVersionHandler();</span>
<span class="nc" id="L197">        return getCompilationUnit(languageVersionHandler);</span>
    }

    static Node getCompilationUnit(LanguageVersionHandler languageVersionHandler, String code) {
<span class="fc" id="L201">        Parser parser = languageVersionHandler.getParser(languageVersionHandler.getDefaultParserOptions());</span>
<span class="fc" id="L202">        Node node = parser.parse(null, new StringReader(code));</span>
<span class="fc" id="L203">        languageVersionHandler.getSymbolFacade().start(node);</span>
<span class="fc" id="L204">        languageVersionHandler.getTypeResolutionFacade(Designer.class.getClassLoader()).start(node);</span>
<span class="fc" id="L205">        return node;</span>
    }

    private Node getCompilationUnit(LanguageVersionHandler languageVersionHandler) {
<span class="nc" id="L209">        return getCompilationUnit(languageVersionHandler, codeEditorPane.getText());</span>
    }

    private static LanguageVersion[] getSupportedLanguageVersions() {
<span class="nc" id="L213">        List&lt;LanguageVersion&gt; languageVersions = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">        for (LanguageVersion languageVersion : LanguageRegistry.findAllVersions()) {</span>
<span class="nc" id="L215">            LanguageVersionHandler languageVersionHandler = languageVersion.getLanguageVersionHandler();</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">            if (languageVersionHandler != null) {</span>
<span class="nc" id="L217">                Parser parser = languageVersionHandler.getParser(languageVersionHandler.getDefaultParserOptions());</span>
<span class="nc bnc" id="L218" title="All 4 branches missed.">                if (parser != null &amp;&amp; parser.canParse()) {</span>
<span class="nc" id="L219">                    languageVersions.add(languageVersion);</span>
                }
            }
<span class="nc" id="L222">        }</span>
<span class="nc" id="L223">        return languageVersions.toArray(new LanguageVersion[languageVersions.size()]);</span>
    }

    private LanguageVersion getLanguageVersion() {
<span class="nc" id="L227">        return getSupportedLanguageVersions()[selectedLanguageVersionIndex()];</span>
    }

    private void setLanguageVersion(LanguageVersion languageVersion) {
<span class="nc bnc" id="L231" title="All 2 branches missed.">        if (languageVersion != null) {</span>
<span class="nc" id="L232">            LanguageVersion[] versions = getSupportedLanguageVersions();</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">            for (int i = 0; i &lt; versions.length; i++) {</span>
<span class="nc" id="L234">                LanguageVersion version = versions[i];</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">                if (languageVersion.equals(version)) {</span>
<span class="nc" id="L236">                    languageVersionMenuItems[i].setSelected(true);</span>
<span class="nc" id="L237">                    break;</span>
                }
            }
        }
<span class="nc" id="L241">    }</span>

    private int selectedLanguageVersionIndex() {
<span class="nc bnc" id="L244" title="All 2 branches missed.">        for (int i = 0; i &lt; languageVersionMenuItems.length; i++) {</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">            if (languageVersionMenuItems[i].isSelected()) {</span>
<span class="nc" id="L246">                return i;</span>
            }
        }
<span class="nc" id="L249">        throw new RuntimeException(&quot;Initial default language version not specified&quot;);</span>
    }

    private LanguageVersionHandler getLanguageVersionHandler() {
<span class="nc" id="L253">        LanguageVersion languageVersion = getLanguageVersion();</span>
<span class="nc" id="L254">        return languageVersion.getLanguageVersionHandler();</span>
    }

    private class ExceptionNode implements TreeNode {

        private Object item;
        private ExceptionNode[] kids;

<span class="nc" id="L262">        ExceptionNode(Object theItem) {</span>
<span class="nc" id="L263">            item = theItem;</span>

<span class="nc bnc" id="L265" title="All 2 branches missed.">            if (item instanceof ParseException) {</span>
<span class="nc" id="L266">                createKids();</span>
            }
<span class="nc" id="L268">        }</span>

        // each line in the error message becomes a separate tree node
        private void createKids() {

<span class="nc" id="L273">            String message = ((ParseException) item).getMessage();</span>
<span class="nc" id="L274">            String[] lines = StringUtil.substringsOf(message, PMD.EOL);</span>

<span class="nc" id="L276">            kids = new ExceptionNode[lines.length];</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">            for (int i = 0; i &lt; lines.length; i++) {</span>
<span class="nc" id="L278">                kids[i] = new ExceptionNode(lines[i]);</span>
            }
<span class="nc" id="L280">        }</span>

        @Override
        public int getChildCount() {
<span class="nc bnc" id="L284" title="All 2 branches missed.">            return kids == null ? 0 : kids.length;</span>
        }

        @Override
        public boolean getAllowsChildren() {
<span class="nc" id="L289">            return false;</span>
        }

        @Override
        public boolean isLeaf() {
<span class="nc bnc" id="L294" title="All 2 branches missed.">            return kids == null;</span>
        }

        @Override
        public TreeNode getParent() {
<span class="nc" id="L299">            return null;</span>
        }

        @Override
        public TreeNode getChildAt(int childIndex) {
<span class="nc" id="L304">            return kids[childIndex];</span>
        }

        public String label() {
<span class="nc" id="L308">            return item.toString();</span>
        }

        @Override
        public Enumeration&lt;TreeNode&gt; children() {
<span class="nc" id="L313">            Enumeration&lt;TreeNode&gt; e = new Enumeration&lt;TreeNode&gt;() {</span>
<span class="nc" id="L314">                int i = 0;</span>

                @Override
                public boolean hasMoreElements() {
<span class="nc bnc" id="L318" title="All 4 branches missed.">                    return kids != null &amp;&amp; i &lt; kids.length;</span>
                }

                @Override
                public ExceptionNode nextElement() {
<span class="nc" id="L323">                    return kids[i++];</span>
                }
            };
<span class="nc" id="L326">            return e;</span>
        }

        @Override
        public int getIndex(TreeNode node) {
<span class="nc bnc" id="L331" title="All 2 branches missed.">            for (int i = 0; i &lt; kids.length; i++) {</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">                if (kids[i] == node) {</span>
<span class="nc" id="L333">                    return i;</span>
                }
            }
<span class="nc" id="L336">            return -1;</span>
        }
    }

    // Tree node that wraps the AST node for the tree widget and
    // any possible children they may have.
    private class ASTTreeNode implements TreeNode {

        private Node node;
        private ASTTreeNode parent;
        private ASTTreeNode[] kids;

<span class="nc" id="L348">        ASTTreeNode(Node theNode) {</span>
<span class="nc" id="L349">            node = theNode;</span>

<span class="nc" id="L351">            Node parent = node.jjtGetParent();</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">            if (parent != null) {</span>
<span class="nc" id="L353">                this.parent = new ASTTreeNode(parent);</span>
            }
<span class="nc" id="L355">        }</span>

<span class="nc" id="L357">        private ASTTreeNode(ASTTreeNode parent, Node theNode) {</span>
<span class="nc" id="L358">            node = theNode;</span>
<span class="nc" id="L359">            this.parent = parent;</span>
<span class="nc" id="L360">        }</span>

        @Override
        public int getChildCount() {
<span class="nc" id="L364">            return node.jjtGetNumChildren();</span>
        }

        @Override
        public boolean getAllowsChildren() {
<span class="nc" id="L369">            return false;</span>
        }

        @Override
        public boolean isLeaf() {
<span class="nc bnc" id="L374" title="All 2 branches missed.">            return node.jjtGetNumChildren() == 0;</span>
        }

        @Override
        public TreeNode getParent() {
<span class="nc" id="L379">            return parent;</span>
        }

        public Scope getScope() {
<span class="nc bnc" id="L383" title="All 2 branches missed.">            if (node instanceof ScopedNode) {</span>
<span class="nc" id="L384">                return ((ScopedNode) node).getScope();</span>
            }
<span class="nc" id="L386">            return null;</span>
        }

        @Override
        public Enumeration&lt;TreeNode&gt; children() {

<span class="nc bnc" id="L392" title="All 2 branches missed.">            if (getChildCount() &gt; 0) {</span>
<span class="nc" id="L393">                getChildAt(0); // force it to build kids</span>
            }

<span class="nc" id="L396">            Enumeration&lt;TreeNode&gt; e = new Enumeration&lt;TreeNode&gt;() {</span>
<span class="nc" id="L397">                int i = 0;</span>

                @Override
                public boolean hasMoreElements() {
<span class="nc bnc" id="L401" title="All 4 branches missed.">                    return kids != null &amp;&amp; i &lt; kids.length;</span>
                }

                @Override
                public ASTTreeNode nextElement() {
<span class="nc" id="L406">                    return kids[i++];</span>
                }
            };
<span class="nc" id="L409">            return e;</span>
        }

        @Override
        public TreeNode getChildAt(int childIndex) {

<span class="nc bnc" id="L415" title="All 2 branches missed.">            if (kids == null) {</span>
<span class="nc" id="L416">                kids = new ASTTreeNode[node.jjtGetNumChildren()];</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">                for (int i = 0; i &lt; kids.length; i++) {</span>
<span class="nc" id="L418">                    kids[i] = new ASTTreeNode(this.parent, node.jjtGetChild(i));</span>
                }
            }
<span class="nc" id="L421">            return kids[childIndex];</span>
        }

        @Override
        public int getIndex(TreeNode node) {

<span class="nc bnc" id="L427" title="All 2 branches missed.">            for (int i = 0; i &lt; kids.length; i++) {</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">                if (kids[i] == node) {</span>
<span class="nc" id="L429">                    return i;</span>
                }
            }
<span class="nc" id="L432">            return -1;</span>
        }

        public String label() {
<span class="nc" id="L436">            LanguageVersionHandler languageVersionHandler = getLanguageVersionHandler();</span>
<span class="nc" id="L437">            StringWriter writer = new StringWriter();</span>
<span class="nc" id="L438">            languageVersionHandler.getDumpFacade(writer, &quot;&quot;, false).start(node);</span>
<span class="nc" id="L439">            return writer.toString();</span>
        }

        public String getToolTipText() {
<span class="nc" id="L443">            String tooltip = &quot;Line: &quot; + node.getBeginLine() + &quot; Column: &quot; + node.getBeginColumn();</span>
<span class="nc" id="L444">            tooltip += &quot; &quot; + label();</span>
<span class="nc" id="L445">            return tooltip;</span>
        }

        public List&lt;String&gt; getAttributes() {
<span class="nc" id="L449">            List&lt;String&gt; result = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L450">            AttributeAxisIterator attributeAxisIterator = new AttributeAxisIterator(node);</span>
<span class="nc bnc" id="L451" title="All 2 branches missed.">            while (attributeAxisIterator.hasNext()) {</span>
<span class="nc" id="L452">                Attribute attribute = attributeAxisIterator.next();</span>
<span class="nc" id="L453">                result.add(attribute.getName() + &quot;=&quot; + attribute.getStringValue());</span>
<span class="nc" id="L454">            }</span>
<span class="nc" id="L455">            return result;</span>
        }
    }

    private TreeCellRenderer createNoImageTreeCellRenderer() {
<span class="nc" id="L460">        DefaultTreeCellRenderer treeCellRenderer = new DefaultTreeCellRenderer();</span>
<span class="nc" id="L461">        treeCellRenderer.setLeafIcon(null);</span>
<span class="nc" id="L462">        treeCellRenderer.setOpenIcon(null);</span>
<span class="nc" id="L463">        treeCellRenderer.setClosedIcon(null);</span>
<span class="nc" id="L464">        return treeCellRenderer;</span>
    }

    // Special tree variant that knows how to retrieve node labels and
    // provides the ability to expand all nodes at once.
    private class TreeWidget extends JTree {

        private static final long serialVersionUID = 1L;

<span class="nc" id="L473">        TreeWidget(Object[] items) {</span>
<span class="nc" id="L474">            super(items);</span>
<span class="nc" id="L475">            setToolTipText(&quot;&quot;);</span>
<span class="nc" id="L476">        }</span>

        @Override
        public String convertValueToText(Object value, boolean selected, boolean expanded, boolean leaf, int row,
                boolean hasFocus) {
<span class="nc bnc" id="L481" title="All 2 branches missed.">            if (value == null) {</span>
<span class="nc" id="L482">                return &quot;&quot;;</span>
            }
<span class="nc bnc" id="L484" title="All 2 branches missed.">            if (value instanceof ASTTreeNode) {</span>
<span class="nc" id="L485">                return ((ASTTreeNode) value).label();</span>
            }
<span class="nc bnc" id="L487" title="All 2 branches missed.">            if (value instanceof ExceptionNode) {</span>
<span class="nc" id="L488">                return ((ExceptionNode) value).label();</span>
            }
<span class="nc" id="L490">            return value.toString();</span>
        }

        @Override
        public String getToolTipText(MouseEvent e) {
<span class="nc bnc" id="L495" title="All 2 branches missed.">            if (getRowForLocation(e.getX(), e.getY()) == -1) {</span>
<span class="nc" id="L496">                return null;</span>
            }
<span class="nc" id="L498">            TreePath curPath = getPathForLocation(e.getX(), e.getY());</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">            if (curPath.getLastPathComponent() instanceof ASTTreeNode) {</span>
<span class="nc" id="L500">                return ((ASTTreeNode) curPath.getLastPathComponent()).getToolTipText();</span>
            } else {
<span class="nc" id="L502">                return super.getToolTipText(e);</span>
            }
        }

        public void expandAll(boolean expand) {
<span class="nc" id="L507">            TreeNode root = (TreeNode) getModel().getRoot();</span>
<span class="nc" id="L508">            expandAll(new TreePath(root), expand);</span>
<span class="nc" id="L509">        }</span>

        private void expandAll(TreePath parent, boolean expand) {
            // Traverse children
<span class="nc" id="L513">            TreeNode node = (TreeNode) parent.getLastPathComponent();</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">            if (node.getChildCount() &gt;= 0) {</span>
<span class="nc bnc" id="L515" title="All 2 branches missed.">                for (Enumeration&lt;? extends TreeNode&gt; e = node.children(); e.hasMoreElements();) {</span>
<span class="nc" id="L516">                    TreeNode n = e.nextElement();</span>
<span class="nc" id="L517">                    TreePath path = parent.pathByAddingChild(n);</span>
<span class="nc" id="L518">                    expandAll(path, expand);</span>
<span class="nc" id="L519">                }</span>
            }

<span class="nc bnc" id="L522" title="All 2 branches missed.">            if (expand) {</span>
<span class="nc" id="L523">                expandPath(parent);</span>
            } else {
<span class="nc" id="L525">                collapsePath(parent);</span>
            }
<span class="nc" id="L527">        }</span>
    }

    private void loadASTTreeData(TreeNode rootNode) {
<span class="nc" id="L531">        astTreeWidget.setModel(new DefaultTreeModel(rootNode));</span>
<span class="nc" id="L532">        astTreeWidget.setRootVisible(true);</span>
<span class="nc" id="L533">        astTreeWidget.expandAll(true);</span>
<span class="nc" id="L534">    }</span>

    private void loadSymbolTableTreeData(TreeNode rootNode) {
<span class="nc bnc" id="L537" title="All 2 branches missed.">        if (rootNode != null) {</span>
<span class="nc" id="L538">            symbolTableTreeWidget.setModel(new DefaultTreeModel(rootNode));</span>
<span class="nc" id="L539">            symbolTableTreeWidget.expandAll(true);</span>
        } else {
<span class="nc" id="L541">            symbolTableTreeWidget.setModel(null);</span>
        }
<span class="nc" id="L543">    }</span>

<span class="nc" id="L545">    private class ShowListener implements ActionListener {</span>
        @Override
        public void actionPerformed(ActionEvent ae) {
            TreeNode tn;
            try {
<span class="nc" id="L550">                Node lastCompilationUnit = getCompilationUnit();</span>
<span class="nc" id="L551">                tn = new ASTTreeNode(lastCompilationUnit);</span>
<span class="nc" id="L552">            } catch (ParseException pe) {</span>
<span class="nc" id="L553">                tn = new ExceptionNode(pe);</span>
<span class="nc" id="L554">            }</span>

<span class="nc" id="L556">            loadASTTreeData(tn);</span>
<span class="nc" id="L557">            loadSymbolTableTreeData(null);</span>
<span class="nc" id="L558">        }</span>
    }

<span class="nc" id="L561">    private class DFAListener implements ActionListener {</span>
        @Override
        public void actionPerformed(ActionEvent ae) {

<span class="nc" id="L565">            LanguageVersion languageVersion = getLanguageVersion();</span>
<span class="nc" id="L566">            DFAGraphRule dfaGraphRule = languageVersion.getLanguageVersionHandler().getDFAGraphRule();</span>
<span class="nc bnc" id="L567" title="All 2 branches missed.">            if (dfaGraphRule != null) {</span>
<span class="nc" id="L568">                final RuleSet rs = new RuleSetFactory().createSingleRuleRuleSet(dfaGraphRule);</span>
<span class="nc" id="L569">                RuleContext ctx = new RuleContext();</span>
<span class="nc" id="L570">                ctx.setSourceCodeFilename(&quot;[no filename].&quot; + languageVersion.getLanguage().getExtensions().get(0));</span>
<span class="nc" id="L571">                StringReader reader = new StringReader(codeEditorPane.getText());</span>
<span class="nc" id="L572">                PMDConfiguration config = new PMDConfiguration();</span>
<span class="nc" id="L573">                config.setDefaultLanguageVersion(languageVersion);</span>

                try {
<span class="nc" id="L576">                    new SourceCodeProcessor(config).processSourceCode(reader, new RuleSets(rs), ctx);</span>
                    // } catch (PMDException pmde) {
                    // loadTreeData(new ExceptionNode(pmde));
<span class="nc" id="L579">                } catch (Exception e) {</span>
<span class="nc" id="L580">                    e.printStackTrace();</span>
<span class="nc" id="L581">                }</span>

<span class="nc" id="L583">                List&lt;DFAGraphMethod&gt; methods = dfaGraphRule.getMethods();</span>
<span class="nc bnc" id="L584" title="All 4 branches missed.">                if (methods != null &amp;&amp; !methods.isEmpty()) {</span>
<span class="nc" id="L585">                    dfaPanel.resetTo(methods, codeEditorPane);</span>
<span class="nc" id="L586">                    dfaPanel.repaint();</span>
                }
            }
<span class="nc" id="L589">        }</span>
    }

<span class="nc" id="L592">    private class XPathListener implements ActionListener {</span>
        @Override
        public void actionPerformed(ActionEvent ae) {
<span class="nc" id="L595">            xpathResults.clear();</span>
<span class="nc bnc" id="L596" title="All 2 branches missed.">            if (StringUtil.isEmpty(xpathQueryArea.getText())) {</span>
<span class="nc" id="L597">                xpathResults.addElement(&quot;XPath query field is empty.&quot;);</span>
<span class="nc" id="L598">                xpathResultList.repaint();</span>
<span class="nc" id="L599">                codeEditorPane.requestFocus();</span>
<span class="nc" id="L600">                return;</span>
            }
<span class="nc" id="L602">            Node c = getCompilationUnit();</span>
            try {
<span class="nc" id="L604">                XPathRule xpathRule = new XPathRule() {</span>
                    @Override
                    public void addViolation(Object data, Node node, String arg) {
<span class="nc" id="L607">                        xpathResults.addElement(node);</span>
<span class="nc" id="L608">                    }</span>
                };
<span class="nc" id="L610">                xpathRule.setMessage(&quot;&quot;);</span>
<span class="nc" id="L611">                xpathRule.setLanguage(getLanguageVersion().getLanguage());</span>
<span class="nc" id="L612">                xpathRule.setXPath(xpathQueryArea.getText());</span>
<span class="nc" id="L613">                xpathRule.setVersion(xpathVersionButtonGroup.getSelection().getActionCommand());</span>

<span class="nc" id="L615">                final RuleSet ruleSet = new RuleSetFactory().createSingleRuleRuleSet(xpathRule);</span>

<span class="nc" id="L617">                RuleSets ruleSets = new RuleSets(ruleSet);</span>

<span class="nc" id="L619">                RuleContext ruleContext = new RuleContext();</span>
<span class="nc" id="L620">                ruleContext.setLanguageVersion(getLanguageVersion());</span>

<span class="nc" id="L622">                List&lt;Node&gt; nodes = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L623">                nodes.add(c);</span>
<span class="nc" id="L624">                ruleSets.apply(nodes, ruleContext, xpathRule.getLanguage());</span>

<span class="nc bnc" id="L626" title="All 2 branches missed.">                if (xpathResults.isEmpty()) {</span>
<span class="nc" id="L627">                    xpathResults.addElement(&quot;No matching nodes &quot; + System.currentTimeMillis());</span>
                }
<span class="nc" id="L629">            } catch (ParseException pe) {</span>
<span class="nc" id="L630">                xpathResults.addElement(pe.fillInStackTrace().getMessage());</span>
<span class="nc" id="L631">            }</span>
<span class="nc" id="L632">            xpathResultList.repaint();</span>
<span class="nc" id="L633">            xpathQueryArea.requestFocus();</span>
<span class="nc" id="L634">        }</span>
    }

<span class="nc" id="L637">    private class SymbolTableListener implements TreeSelectionListener {</span>
        @Override
        public void valueChanged(TreeSelectionEvent e) {
<span class="nc bnc" id="L640" title="All 2 branches missed.">            if (e.getNewLeadSelectionPath() != null) {</span>
<span class="nc" id="L641">                ASTTreeNode astTreeNode = (ASTTreeNode) e.getNewLeadSelectionPath().getLastPathComponent();</span>

<span class="nc" id="L643">                DefaultMutableTreeNode symbolTableTreeNode = new DefaultMutableTreeNode();</span>
<span class="nc" id="L644">                DefaultMutableTreeNode selectedAstTreeNode = new DefaultMutableTreeNode(</span>
                        &quot;AST Node: &quot; + astTreeNode.label());
<span class="nc" id="L646">                symbolTableTreeNode.add(selectedAstTreeNode);</span>

<span class="nc" id="L648">                List&lt;Scope&gt; scopes = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L649">                Scope scope = astTreeNode.getScope();</span>
<span class="nc bnc" id="L650" title="All 2 branches missed.">                while (scope != null) {</span>
<span class="nc" id="L651">                    scopes.add(scope);</span>
<span class="nc" id="L652">                    scope = scope.getParent();</span>
                }
<span class="nc" id="L654">                Collections.reverse(scopes);</span>
<span class="nc bnc" id="L655" title="All 2 branches missed.">                for (int i = 0; i &lt; scopes.size(); i++) {</span>
<span class="nc" id="L656">                    scope = scopes.get(i);</span>
<span class="nc" id="L657">                    DefaultMutableTreeNode scopeTreeNode = new DefaultMutableTreeNode(</span>
                            &quot;Scope: &quot; + scope.getClass().getSimpleName());
<span class="nc" id="L659">                    selectedAstTreeNode.add(scopeTreeNode);</span>
<span class="nc bnc" id="L660" title="All 2 branches missed.">                    for (Map.Entry&lt;NameDeclaration, List&lt;NameOccurrence&gt;&gt; entry : scope.getDeclarations().entrySet()) {</span>
<span class="nc" id="L661">                        DefaultMutableTreeNode nameDeclarationTreeNode = new DefaultMutableTreeNode(</span>
                                entry.getKey().getClass().getSimpleName() + &quot;: &quot; + entry.getKey());
<span class="nc" id="L663">                        scopeTreeNode.add(nameDeclarationTreeNode);</span>
<span class="nc bnc" id="L664" title="All 2 branches missed.">                        for (NameOccurrence nameOccurrence : entry.getValue()) {</span>
<span class="nc" id="L665">                            DefaultMutableTreeNode nameOccurranceTreeNode = new DefaultMutableTreeNode(</span>
                                    &quot;Name occurrence: &quot; + nameOccurrence);
<span class="nc" id="L667">                            nameDeclarationTreeNode.add(nameOccurranceTreeNode);</span>
<span class="nc" id="L668">                        }</span>
<span class="nc" id="L669">                    }</span>
                }

<span class="nc" id="L672">                List&lt;String&gt; attributes = astTreeNode.getAttributes();</span>
<span class="nc" id="L673">                DefaultMutableTreeNode attributesNode = new DefaultMutableTreeNode(</span>
                        &quot;Attributes (accessible via XPath):&quot;);
<span class="nc" id="L675">                selectedAstTreeNode.add(attributesNode);</span>
<span class="nc bnc" id="L676" title="All 2 branches missed.">                for (String attribute : attributes) {</span>
<span class="nc" id="L677">                    attributesNode.add(new DefaultMutableTreeNode(attribute));</span>
<span class="nc" id="L678">                }</span>

<span class="nc" id="L680">                loadSymbolTableTreeData(symbolTableTreeNode);</span>
            }
<span class="nc" id="L682">        }</span>
    }

<span class="nc" id="L685">    private class CodeHighlightListener implements TreeSelectionListener {</span>
        @Override
        public void valueChanged(TreeSelectionEvent e) {
<span class="nc bnc" id="L688" title="All 2 branches missed.">            if (e.getNewLeadSelectionPath() != null) {</span>
<span class="nc" id="L689">                ASTTreeNode selected = (ASTTreeNode) e.getNewLeadSelectionPath().getLastPathComponent();</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">                if (selected != null) {</span>
<span class="nc" id="L691">                    codeEditorPane.select(selected.node);</span>
                }
            }
<span class="nc" id="L694">        }</span>
    }

<span class="nc" id="L697">    private class ASTListCellRenderer extends JLabel implements ListCellRenderer {</span>
        private static final long serialVersionUID = 1L;

        @Override
        public Component getListCellRendererComponent(JList list, Object value, int index, boolean isSelected,
                boolean cellHasFocus) {

<span class="nc bnc" id="L704" title="All 2 branches missed.">            if (isSelected) {</span>
<span class="nc" id="L705">                setBackground(list.getSelectionBackground());</span>
<span class="nc" id="L706">                setForeground(list.getSelectionForeground());</span>
            } else {
<span class="nc" id="L708">                setBackground(list.getBackground());</span>
<span class="nc" id="L709">                setForeground(list.getForeground());</span>
            }

            String text;
<span class="nc bnc" id="L713" title="All 2 branches missed.">            if (value instanceof Node) {</span>
<span class="nc" id="L714">                Node node = (Node) value;</span>
<span class="nc" id="L715">                StringBuffer sb = new StringBuffer();</span>
<span class="nc" id="L716">                String name = node.getClass().getName().substring(node.getClass().getName().lastIndexOf('.') + 1);</span>
<span class="nc bnc" id="L717" title="All 2 branches missed.">                if (Proxy.isProxyClass(value.getClass())) {</span>
<span class="nc" id="L718">                    name = value.toString();</span>
                }
<span class="nc" id="L720">                sb.append(name).append(&quot; at line &quot;).append(node.getBeginLine()).append(&quot; column &quot;)</span>
                        .append(node.getBeginColumn()).append(PMD.EOL);
<span class="nc" id="L722">                text = sb.toString();</span>
<span class="nc" id="L723">            } else {</span>
<span class="nc" id="L724">                text = value.toString();</span>
            }
<span class="nc" id="L726">            setText(text);</span>
<span class="nc" id="L727">            return this;</span>
        }
    }

<span class="nc" id="L731">    private class ASTSelectionListener implements ListSelectionListener {</span>
        @Override
        public void valueChanged(ListSelectionEvent e) {
<span class="nc" id="L734">            ListSelectionModel lsm = (ListSelectionModel) e.getSource();</span>
<span class="nc bnc" id="L735" title="All 2 branches missed.">            if (!lsm.isSelectionEmpty()) {</span>
<span class="nc" id="L736">                Object o = xpathResults.get(lsm.getMinSelectionIndex());</span>
<span class="nc bnc" id="L737" title="All 2 branches missed.">                if (o instanceof Node) {</span>
<span class="nc" id="L738">                    codeEditorPane.select((Node) o);</span>
                }
            }
<span class="nc" id="L741">        }</span>
    }

    private JMenuBar createMenuBar() {
<span class="nc" id="L745">        JMenuBar menuBar = new JMenuBar();</span>
<span class="nc" id="L746">        JMenu menu = new JMenu(&quot;Language&quot;);</span>
<span class="nc" id="L747">        ButtonGroup group = new ButtonGroup();</span>

<span class="nc" id="L749">        LanguageVersion[] languageVersions = getSupportedLanguageVersions();</span>
<span class="nc bnc" id="L750" title="All 2 branches missed.">        for (int i = 0; i &lt; languageVersions.length; i++) {</span>
<span class="nc" id="L751">            LanguageVersion languageVersion = languageVersions[i];</span>
<span class="nc" id="L752">            JRadioButtonMenuItem button = new JRadioButtonMenuItem(languageVersion.getShortName());</span>
<span class="nc" id="L753">            languageVersionMenuItems[i] = button;</span>
<span class="nc" id="L754">            group.add(button);</span>
<span class="nc" id="L755">            menu.add(button);</span>
        }
<span class="nc" id="L757">        languageVersionMenuItems[getDefaultLanguageVersionSelectionIndex()].setSelected(true);</span>
<span class="nc" id="L758">        menuBar.add(menu);</span>

<span class="nc" id="L760">        JMenu actionsMenu = new JMenu(&quot;Actions&quot;);</span>
<span class="nc" id="L761">        JMenuItem copyXMLItem = new JMenuItem(&quot;Copy xml to clipboard&quot;);</span>
<span class="nc" id="L762">        copyXMLItem.addActionListener(new ActionListener() {</span>
            @Override
            public void actionPerformed(ActionEvent e) {
<span class="nc" id="L765">                copyXmlToClipboard();</span>
<span class="nc" id="L766">            }</span>
        });
<span class="nc" id="L768">        actionsMenu.add(copyXMLItem);</span>
<span class="nc" id="L769">        JMenuItem createRuleXMLItem = new JMenuItem(&quot;Create rule XML&quot;);</span>
<span class="nc" id="L770">        createRuleXMLItem.addActionListener(new ActionListener() {</span>
            @Override
            public void actionPerformed(ActionEvent e) {
<span class="nc" id="L773">                createRuleXML();</span>
<span class="nc" id="L774">            }</span>
        });
<span class="nc" id="L776">        actionsMenu.add(createRuleXMLItem);</span>
<span class="nc" id="L777">        menuBar.add(actionsMenu);</span>

<span class="nc" id="L779">        return menuBar;</span>
    }

    private void createRuleXML() {
<span class="nc" id="L783">        CreateXMLRulePanel rulePanel = new CreateXMLRulePanel(xpathQueryArea, codeEditorPane);</span>
<span class="nc" id="L784">        JFrame xmlframe = new JFrame(&quot;Create XML Rule&quot;);</span>
<span class="nc" id="L785">        xmlframe.setContentPane(rulePanel);</span>
<span class="nc" id="L786">        xmlframe.setDefaultCloseOperation(WindowConstants.DISPOSE_ON_CLOSE);</span>
<span class="nc" id="L787">        xmlframe.setSize(new Dimension(600, 700));</span>
<span class="nc" id="L788">        xmlframe.addComponentListener(new java.awt.event.ComponentAdapter() {</span>
            @Override
            public void componentResized(ComponentEvent e) {
<span class="nc" id="L791">                JFrame tmp = (JFrame) e.getSource();</span>
<span class="nc bnc" id="L792" title="All 4 branches missed.">                if (tmp.getWidth() &lt; 600 || tmp.getHeight() &lt; 700) {</span>
<span class="nc" id="L793">                    tmp.setSize(600, 700);</span>
                }
<span class="nc" id="L795">            }</span>
        });
<span class="nc" id="L797">        int screenHeight = Toolkit.getDefaultToolkit().getScreenSize().height;</span>
<span class="nc" id="L798">        int screenWidth = Toolkit.getDefaultToolkit().getScreenSize().width;</span>
<span class="nc" id="L799">        xmlframe.pack();</span>
<span class="nc" id="L800">        xmlframe.setLocation((screenWidth - xmlframe.getWidth()) / 2, (screenHeight - xmlframe.getHeight()) / 2);</span>
<span class="nc" id="L801">        xmlframe.setVisible(true);</span>
<span class="nc" id="L802">    }</span>

    private JComponent createCodeEditorPanel() {
<span class="nc" id="L805">        JPanel p = new JPanel();</span>
<span class="nc" id="L806">        p.setLayout(new BorderLayout());</span>
<span class="nc" id="L807">        codeEditorPane.setBorder(BorderFactory.createLineBorder(Color.black));</span>
<span class="nc" id="L808">        makeTextComponentUndoable(codeEditorPane);</span>

<span class="nc" id="L810">        p.add(new JLabel(&quot;Source code:&quot;), BorderLayout.NORTH);</span>
<span class="nc" id="L811">        p.add(new JScrollPane(codeEditorPane), BorderLayout.CENTER);</span>

<span class="nc" id="L813">        return p;</span>
    }

    private JComponent createASTPanel() {
<span class="nc" id="L817">        astTreeWidget.setCellRenderer(createNoImageTreeCellRenderer());</span>
<span class="nc" id="L818">        TreeSelectionModel model = astTreeWidget.getSelectionModel();</span>
<span class="nc" id="L819">        model.setSelectionMode(TreeSelectionModel.SINGLE_TREE_SELECTION);</span>
<span class="nc" id="L820">        model.addTreeSelectionListener(new SymbolTableListener());</span>
<span class="nc" id="L821">        model.addTreeSelectionListener(new CodeHighlightListener());</span>
<span class="nc" id="L822">        return new JScrollPane(astTreeWidget);</span>
    }

    private JComponent createXPathResultPanel() {
<span class="nc" id="L826">        xpathResults.addElement(&quot;No XPath results yet, run an XPath Query first.&quot;);</span>
<span class="nc" id="L827">        xpathResultList.setBorder(BorderFactory.createLineBorder(Color.black));</span>
<span class="nc" id="L828">        xpathResultList.setFixedCellWidth(300);</span>
<span class="nc" id="L829">        xpathResultList.setCellRenderer(new ASTListCellRenderer());</span>
<span class="nc" id="L830">        xpathResultList.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);</span>
<span class="nc" id="L831">        xpathResultList.getSelectionModel().addListSelectionListener(new ASTSelectionListener());</span>
<span class="nc" id="L832">        JScrollPane scrollPane = new JScrollPane();</span>
<span class="nc" id="L833">        scrollPane.getViewport().setView(xpathResultList);</span>
<span class="nc" id="L834">        return scrollPane;</span>
    }

    private JPanel createXPathQueryPanel() {
<span class="nc" id="L838">        JPanel p = new JPanel();</span>
<span class="nc" id="L839">        p.setLayout(new BorderLayout());</span>
<span class="nc" id="L840">        xpathQueryArea.setBorder(BorderFactory.createLineBorder(Color.black));</span>
<span class="nc" id="L841">        makeTextComponentUndoable(xpathQueryArea);</span>
<span class="nc" id="L842">        JScrollPane scrollPane = new JScrollPane(xpathQueryArea);</span>
<span class="nc" id="L843">        scrollPane.setHorizontalScrollBarPolicy(ScrollPaneConstants.HORIZONTAL_SCROLLBAR_AS_NEEDED);</span>
<span class="nc" id="L844">        scrollPane.setVerticalScrollBarPolicy(ScrollPaneConstants.VERTICAL_SCROLLBAR_AS_NEEDED);</span>
<span class="nc" id="L845">        final JButton b = createGoButton();</span>

<span class="nc" id="L847">        JPanel topPanel = new JPanel();</span>
<span class="nc" id="L848">        topPanel.setLayout(new BorderLayout());</span>
<span class="nc" id="L849">        topPanel.add(new JLabel(&quot;XPath Query (if any):&quot;), BorderLayout.WEST);</span>
<span class="nc" id="L850">        topPanel.add(createXPathVersionPanel(), BorderLayout.EAST);</span>

<span class="nc" id="L852">        p.add(topPanel, BorderLayout.NORTH);</span>
<span class="nc" id="L853">        p.add(scrollPane, BorderLayout.CENTER);</span>
<span class="nc" id="L854">        p.add(b, BorderLayout.SOUTH);</span>

<span class="nc" id="L856">        return p;</span>
    }

    private JComponent createSymbolTableResultPanel() {
<span class="nc" id="L860">        symbolTableTreeWidget.setCellRenderer(createNoImageTreeCellRenderer());</span>
<span class="nc" id="L861">        return new JScrollPane(symbolTableTreeWidget);</span>
    }

    private JPanel createXPathVersionPanel() {
<span class="nc" id="L865">        JPanel p = new JPanel();</span>
<span class="nc" id="L866">        p.add(new JLabel(&quot;XPath Version:&quot;));</span>
<span class="nc bnc" id="L867" title="All 2 branches missed.">        for (Object[] values : XPathRule.VERSION_DESCRIPTOR.choices()) {</span>
<span class="nc" id="L868">            JRadioButton b = new JRadioButton();</span>
<span class="nc" id="L869">            b.setText((String) values[0]);</span>
<span class="nc" id="L870">            b.setActionCommand(b.getText());</span>
<span class="nc bnc" id="L871" title="All 2 branches missed.">            if (values[0].equals(XPathRule.VERSION_DESCRIPTOR.defaultValue())) {</span>
<span class="nc" id="L872">                b.setSelected(true);</span>
            }
<span class="nc" id="L874">            xpathVersionButtonGroup.add(b);</span>
<span class="nc" id="L875">            p.add(b);</span>
        }
<span class="nc" id="L877">        return p;</span>
    }

    private JButton createGoButton() {
<span class="nc" id="L881">        JButton b = new JButton(&quot;Go&quot;);</span>
<span class="nc" id="L882">        b.setMnemonic('g');</span>
<span class="nc" id="L883">        b.addActionListener(new ShowListener());</span>
<span class="nc" id="L884">        b.addActionListener(new XPathListener());</span>
<span class="nc" id="L885">        b.addActionListener(new DFAListener());</span>
<span class="nc" id="L886">        b.addActionListener(new ActionListener() {</span>
            @Override
            public void actionPerformed(ActionEvent e) {
<span class="nc" id="L889">                saveSettings();</span>
<span class="nc" id="L890">            }</span>
        });
<span class="nc" id="L892">        return b;</span>
    }

    private static void makeTextComponentUndoable(JTextComponent textConponent) {
<span class="nc" id="L896">        final UndoManager undoManager = new UndoManager();</span>
<span class="nc" id="L897">        textConponent.getDocument().addUndoableEditListener(new UndoableEditListener() {</span>
            @Override
            public void undoableEditHappened(UndoableEditEvent evt) {
<span class="nc" id="L900">                undoManager.addEdit(evt.getEdit());</span>
<span class="nc" id="L901">            }</span>
        });
<span class="nc" id="L903">        ActionMap actionMap = textConponent.getActionMap();</span>
<span class="nc" id="L904">        InputMap inputMap = textConponent.getInputMap();</span>
<span class="nc" id="L905">        actionMap.put(&quot;Undo&quot;, new AbstractAction(&quot;Undo&quot;) {</span>
            @Override
            public void actionPerformed(ActionEvent evt) {
                try {
<span class="nc bnc" id="L909" title="All 2 branches missed.">                    if (undoManager.canUndo()) {</span>
<span class="nc" id="L910">                        undoManager.undo();</span>
                    }
<span class="nc" id="L912">                } catch (CannotUndoException e) {</span>
<span class="nc" id="L913">                }</span>
<span class="nc" id="L914">            }</span>
        });
<span class="nc" id="L916">        inputMap.put(KeyStroke.getKeyStroke(&quot;control Z&quot;), &quot;Undo&quot;);</span>

<span class="nc" id="L918">        actionMap.put(&quot;Redo&quot;, new AbstractAction(&quot;Redo&quot;) {</span>
            @Override
            public void actionPerformed(ActionEvent evt) {
                try {
<span class="nc bnc" id="L922" title="All 2 branches missed.">                    if (undoManager.canRedo()) {</span>
<span class="nc" id="L923">                        undoManager.redo();</span>
                    }
<span class="nc" id="L925">                } catch (CannotRedoException e) {</span>
<span class="nc" id="L926">                }</span>
<span class="nc" id="L927">            }</span>
        });
<span class="nc" id="L929">        inputMap.put(KeyStroke.getKeyStroke(&quot;control Y&quot;), &quot;Redo&quot;);</span>
<span class="nc" id="L930">    }</span>

    public static void main(String[] args) {
<span class="nc" id="L933">        new Designer(args);</span>
<span class="nc" id="L934">    }</span>

    final void setCodeEditPaneText(String text) {
<span class="nc" id="L937">        codeEditorPane.setText(text);</span>
<span class="nc" id="L938">    }</span>

    private String getXmlTreeCode() {
<span class="nc bnc" id="L941" title="All 4 branches missed.">        if (codeEditorPane.getText() != null &amp;&amp; codeEditorPane.getText().trim().length() &gt; 0) {</span>
<span class="nc" id="L942">            Node cu = getCompilationUnit();</span>
<span class="nc" id="L943">            return getXmlTreeCode(cu);</span>
        }
<span class="nc" id="L945">        return null;</span>
    }

    static final String getXmlTreeCode(Node cu) {
<span class="fc" id="L949">        String xml = null;</span>
<span class="pc bpc" id="L950" title="1 of 2 branches missed.">        if (cu != null) {</span>
            try {
<span class="fc" id="L952">                xml = getXmlString(cu);</span>
<span class="nc" id="L953">            } catch (TransformerException e) {</span>
<span class="nc" id="L954">                e.printStackTrace();</span>
<span class="nc" id="L955">                xml = &quot;Error trying to construct XML representation&quot;;</span>
<span class="fc" id="L956">            }</span>
        }
<span class="fc" id="L958">        return xml;</span>
    }

    private void copyXmlToClipboard() {
<span class="nc" id="L962">        String xml = getXmlTreeCode();</span>
<span class="nc bnc" id="L963" title="All 2 branches missed.">        if (xml != null) {</span>
<span class="nc" id="L964">            Toolkit.getDefaultToolkit().getSystemClipboard().setContents(new StringSelection(xml), this);</span>
        }
<span class="nc" id="L966">    }</span>

    /**
     * Returns an unformatted xml string (without the declaration)
     *
     * @throws TransformerException
     *             if the XML cannot be converted to a string
     */
    private static String getXmlString(Node node) throws TransformerException {
<span class="fc" id="L975">        StringWriter writer = new StringWriter();</span>

<span class="fc" id="L977">        Source source = new DOMSource(node.getAsDocument());</span>
<span class="fc" id="L978">        Result result = new StreamResult(writer);</span>
<span class="fc" id="L979">        TransformerFactory transformerFactory = TransformerFactory.newInstance();</span>
<span class="fc" id="L980">        Transformer xformer = transformerFactory.newTransformer();</span>
<span class="fc" id="L981">        xformer.setOutputProperty(OutputKeys.INDENT, &quot;yes&quot;);</span>
<span class="fc" id="L982">        xformer.transform(source, result);</span>

<span class="fc" id="L984">        return writer.toString();</span>
    }

    @Override
    public void lostOwnership(Clipboard clipboard, Transferable contents) {
<span class="nc" id="L989">    }</span>

    private void loadSettings() {
<span class="nc" id="L992">        InputStream stream = null;</span>
        try {
<span class="nc" id="L994">            File file = new File(SETTINGS_FILE_NAME);</span>
<span class="nc bnc" id="L995" title="All 2 branches missed.">            if (file.exists()) {</span>
<span class="nc" id="L996">                DocumentBuilder builder = DocumentBuilderFactory.newInstance().newDocumentBuilder();</span>
<span class="nc" id="L997">                stream = new FileInputStream(file);</span>
<span class="nc" id="L998">                Document document = builder.parse(stream);</span>
<span class="nc" id="L999">                Element settingsElement = document.getDocumentElement();</span>
<span class="nc" id="L1000">                Element codeElement = (Element) settingsElement.getElementsByTagName(&quot;code&quot;).item(0);</span>
<span class="nc" id="L1001">                Element xpathElement = (Element) settingsElement.getElementsByTagName(&quot;xpath&quot;).item(0);</span>

<span class="nc" id="L1003">                String code = getTextContext(codeElement);</span>
<span class="nc" id="L1004">                String languageVersion = codeElement.getAttribute(&quot;language-version&quot;);</span>
<span class="nc" id="L1005">                String xpath = getTextContext(xpathElement);</span>
<span class="nc" id="L1006">                String xpathVersion = xpathElement.getAttribute(&quot;version&quot;);</span>

<span class="nc" id="L1008">                codeEditorPane.setText(code);</span>
<span class="nc" id="L1009">                setLanguageVersion(LanguageRegistry.findLanguageVersionByTerseName(languageVersion));</span>
<span class="nc" id="L1010">                xpathQueryArea.setText(xpath);</span>
<span class="nc bnc" id="L1011" title="All 2 branches missed.">                for (Enumeration&lt;AbstractButton&gt; e = xpathVersionButtonGroup.getElements(); e.hasMoreElements();) {</span>
<span class="nc" id="L1012">                    AbstractButton button = e.nextElement();</span>
<span class="nc bnc" id="L1013" title="All 2 branches missed.">                    if (xpathVersion.equals(button.getActionCommand())) {</span>
<span class="nc" id="L1014">                        button.setSelected(true);</span>
<span class="nc" id="L1015">                        break;</span>
                    }
<span class="nc" id="L1017">                }</span>
            }
<span class="nc" id="L1019">        } catch (ParserConfigurationException e) {</span>
<span class="nc" id="L1020">            e.printStackTrace();</span>
<span class="nc" id="L1021">        } catch (IOException e) {</span>
<span class="nc" id="L1022">            e.printStackTrace();</span>
<span class="nc" id="L1023">        } catch (SAXException e) {</span>
<span class="nc" id="L1024">            e.printStackTrace();</span>
        } finally {
<span class="nc" id="L1026">            IOUtils.closeQuietly(stream);</span>
<span class="nc" id="L1027">        }</span>
<span class="nc" id="L1028">    }</span>

    private void saveSettings() {
        try {
<span class="nc" id="L1032">            DocumentBuilderFactory documentBuilderFactory = DocumentBuilderFactory.newInstance();</span>
<span class="nc" id="L1033">            DocumentBuilder documentBuilder = documentBuilderFactory.newDocumentBuilder();</span>
<span class="nc" id="L1034">            Document document = documentBuilder.newDocument();</span>

<span class="nc" id="L1036">            Element settingsElement = document.createElement(&quot;settings&quot;);</span>
<span class="nc" id="L1037">            document.appendChild(settingsElement);</span>

<span class="nc" id="L1039">            Element codeElement = document.createElement(&quot;code&quot;);</span>
<span class="nc" id="L1040">            settingsElement.appendChild(codeElement);</span>
<span class="nc" id="L1041">            codeElement.setAttribute(&quot;language-version&quot;, getLanguageVersion().getTerseName());</span>
<span class="nc" id="L1042">            codeElement.appendChild(document.createCDATASection(codeEditorPane.getText()));</span>

<span class="nc" id="L1044">            Element xpathElement = document.createElement(&quot;xpath&quot;);</span>
<span class="nc" id="L1045">            settingsElement.appendChild(xpathElement);</span>
<span class="nc" id="L1046">            xpathElement.setAttribute(&quot;version&quot;, xpathVersionButtonGroup.getSelection().getActionCommand());</span>
<span class="nc" id="L1047">            xpathElement.appendChild(document.createCDATASection(xpathQueryArea.getText()));</span>

<span class="nc" id="L1049">            TransformerFactory transformerFactory = TransformerFactory.newInstance();</span>
<span class="nc" id="L1050">            Transformer transformer = transformerFactory.newTransformer();</span>
<span class="nc" id="L1051">            transformer.setOutputProperty(OutputKeys.METHOD, &quot;xml&quot;);</span>
            // This is as close to pretty printing as we'll get using standard
            // Java APIs.
<span class="nc" id="L1054">            transformer.setOutputProperty(OutputKeys.INDENT, &quot;yes&quot;);</span>
<span class="nc" id="L1055">            transformer.setOutputProperty(&quot;{http://xml.apache.org/xslt}indent-amount&quot;, &quot;3&quot;);</span>
<span class="nc" id="L1056">            transformer.setOutputProperty(OutputKeys.ENCODING, &quot;UTF-8&quot;);</span>

<span class="nc" id="L1058">            Source source = new DOMSource(document);</span>
<span class="nc" id="L1059">            Result result = new StreamResult(new FileWriter(new File(SETTINGS_FILE_NAME)));</span>
<span class="nc" id="L1060">            transformer.transform(source, result);</span>
<span class="nc" id="L1061">        } catch (ParserConfigurationException e) {</span>
<span class="nc" id="L1062">            e.printStackTrace();</span>
<span class="nc" id="L1063">        } catch (IOException e) {</span>
<span class="nc" id="L1064">            e.printStackTrace();</span>
<span class="nc" id="L1065">        } catch (TransformerException e) {</span>
<span class="nc" id="L1066">            e.printStackTrace();</span>
<span class="nc" id="L1067">        }</span>
<span class="nc" id="L1068">    }</span>

    private String getTextContext(Element element) {
<span class="nc" id="L1071">        StringBuilder buf = new StringBuilder();</span>
<span class="nc bnc" id="L1072" title="All 2 branches missed.">        for (int i = 0; i &lt; element.getChildNodes().getLength(); i++) {</span>
<span class="nc" id="L1073">            org.w3c.dom.Node child = element.getChildNodes().item(i);</span>
<span class="nc bnc" id="L1074" title="All 2 branches missed.">            if (child instanceof Text) {</span>
<span class="nc" id="L1075">                buf.append(((Text) child).getData());</span>
            }
        }
<span class="nc" id="L1078">        return buf.toString();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>